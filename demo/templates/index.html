<!doctype html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>Human Detection & CSI Activity</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.24.2.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #eef2f5;
    }

    .wrap {
      display: flex;
      height: 100vh;
    }

    .left-col {
      flex: 2;
      display: flex;
      flex-direction: column;
    }

    .video-box {
      flex: 5 1 0;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    .video-box img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 8px;
    }

    .panel {
      flex: 1;
      padding: 30px;
      background: #fff;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .btn {
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background: #4a90e2;
      color: #fff;
      cursor: pointer;
    }

    .btn:hover {
      background: #357abd;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
    }

    .dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #e74c3c;
      transition: background .3s;
    }

    .tracking .dot {
      background: #2ecc71;
    }

    .log {
      flex: 1;
      background: #f7f9fb;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      overflow-y: auto;
      font-size: 14px;
    }

    .zones-container {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      gap: 8px;
    }

    .zone-box {
      background: #f0f0f0;
      border: 2px solid #ddd;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }

    .zone-box.active {
      background: #ff6b6b;
      color: white;
      border-color: #e74c3c;
    }

    .control-room {
      background: #2c3e50;
      color: white;
      border: 2px solid #34495e;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 4px;
      padding: 12px 0;
    }

    .door {
      background: #8b4513;
      color: white;
      border: 2px solid #654321;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
      margin-top: 4px;
      width: 40%;
      margin-left: auto;
      margin-right: auto;
      padding: 10px 0;
    }

    .camera-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 4px 0;
    }

    .camera-dot {
      width: 16px;
      height: 16px;
      background: #e74c3c;
      border-radius: 50%;
      margin-bottom: 6px;
    }

    .camera-label {
      font-size: 14px;
      color: #666;
      font-weight: bold;
    }

    .log-entry {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      margin-bottom: 6px;
      background: #fff;
      border-radius: 4px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .log-entry .ts {
      font-family: monospace;
      font-size: 12px;
      color: #888;
      min-width: 60px;
    }

    .plot-box {
      flex: 5 1 0;
      background: #fafbfc;
      border: 1px solid #ddd;
      border-radius: 4px;
      display: flex;
    }

    .plot-box img {
      width: 100%;
      height: auto;
      max-height: 100%;
      object-fit: contain;
    }

    #plots {
      flex: 1;
      width: 100%;
      height: 100%;
    }

    .alert-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 0, 0, 0.6);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease;
    }

    .alert-overlay.active {
      opacity: 1;
    }
  .zone-box.selected {
    background: #4a90e2;
    color: white;
    border-color: #357abd;
    transform: scale(1.05);
  }

  .zone-box {
    cursor: pointer;
    transition: all 0.2s;
  }

  .zone-box:hover {
    background: #e0e0e0;
    transform: scale(1.05);
  }
  </style>
</head>

<body>


  <div class="wrap">
    <div class="left-col">
      <div class="video-box">
        <img src="{{ url_for('video_feed') }}" />
        <div id="alert-overlay" class="alert-overlay"></div>
      </div>
      <div class="plot-box">
        <div id="plots"></div>
      </div>
    </div>
    <div class="panel">
      <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button class="btn" onclick="requestReset()">카메라 리셋</button>
        <button class="btn" onclick="requestRedetection()">사람 재검출</button>
      </div>
      <div id="status" class="status waiting">
        <div class="dot"></div>
        <div class="text">Detection 모드</div>
      </div>
      <div id="alert-log" class="log"></div>
      <div class="control-room">상황실</div>
      <div class="zones-container">
        <div class="zone-box" id="zone-2" onclick="showZoneGraph(2)">Zone 2</div>
        <div class="zone-box" id="zone-1" onclick="showZoneGraph(1)">Zone 1</div>
        <div class="zone-box" id="zone-4" onclick="showZoneGraph(4)">Zone 4</div>
        <div class="zone-box" id="zone-3" onclick="showZoneGraph(3)">Zone 3</div>
        <div class="zone-box" id="zone-6" onclick="showZoneGraph(6)">Zone 6</div>
        <div class="zone-box" id="zone-5" onclick="showZoneGraph(5)">Zone 5</div>
      </div>
      <div class="camera-indicator">
        <div class="camera-dot"></div>
        <div class="camera-label">카메라</div>
      </div>
      <div class="door">출입문</div>
    </div>
  </div>

  <script>
    function updateStatus(codeOrMode) {
      const status = document.getElementById("status");
      const text = status.querySelector(".text");

      // 알림 코드에 따른 상태 업데이트
      if (codeOrMode === "00" || codeOrMode === "detection") {
        // 시스템 시작 또는 Detection 모드
        status.classList.remove("tracking");
        text.textContent = "Detection 모드";
      } else if (codeOrMode === "01" || codeOrMode === "tracking") {
        // 사람 감지 또는 Tracking 모드
        status.classList.add("tracking");
        text.textContent = "Tracking 모드";
      } else if (codeOrMode === "02" || codeOrMode === "csi") {
        // 사람 손실 또는 CSI 모드
        status.classList.remove("tracking");
        text.textContent = "CSI 모드";
      } else if (codeOrMode === "03") {
        // 정지 행동 - Tracking Mode 유지
        status.classList.add("tracking");
        text.textContent = "Tracking 모드";
      } else if (codeOrMode === "04") {
      }
    }

    function addLogEntry(code, message) {
      const entry = document.createElement("div");
      entry.className = "log-entry";

      const ts = document.createElement("span");
      ts.className = "ts";
      ts.textContent = new Date().toLocaleTimeString();

      const txt = document.createElement("span");
      txt.textContent = `${code}: ${message}`;

      entry.append(ts, txt);

      const logDiv = document.getElementById("alert-log");
      if (logDiv.firstChild) {
        logDiv.insertBefore(entry, logDiv.firstChild);
      } else {
        logDiv.appendChild(entry);
      }
    }

    // --- Alerts (SSE) -------------------------------------------------
    let alertEvt = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;

    function connectAlerts() {
      try {
        alertEvt = new EventSource("/alerts");

        alertEvt.onmessage = e => {
          if (!e.data.trim()) return;
          try {
            const { code, message } = JSON.parse(e.data);
            addLogEntry(code, message);
            updateStatus(code);
          } catch (error) {
            console.error("Alert parsing error:", error);
          }
        };

        alertEvt.onerror = e => {
          console.error("SSE connection error:", e);
          alertEvt.close();
          reconnectAlerts();
        };

        alertEvt.onopen = e => {
          console.log("SSE connection established");
          reconnectAttempts = 0;
        };

      } catch (error) {
        console.error("Failed to create EventSource:", error);
        reconnectAlerts();
      }
    }

    function reconnectAlerts() {
      if (reconnectAttempts < maxReconnectAttempts) {
        reconnectAttempts++;
        console.log(`Reconnecting alerts... (${reconnectAttempts}/${maxReconnectAttempts})`);
        setTimeout(connectAlerts, 200);
      } else {
        console.error("Max reconnection attempts reached");
      }
    }

    connectAlerts();

    // --- Analysis Results Handler ------------------------------------------
    async function handleAnalysisResult(event) {
      const response = await fetch("/analysis_result");
      if (response.ok) {
        const data = await response.json();
        addLogEntry("분석", data.message);
      }
    }

    // --- CSI Plot (SocketIO + Plotly) ---------------------------------
    const socket = io("/csi");
    const gd = document.getElementById("plots");
    const trMap = {};             // topic → {act, thr, flag}
    const MAXPTS = 500;
    
    const zoneTopics = {
      1: "L0382/ESP/1",
      2: "L0382/ESP/2",
      3: "L0382/ESP/3",
      4: "L0382/ESP/4",
      5: "L0382/ESP/5",
      6: "L0382/ESP/6",
      7: "L0382/ESP/7",
      8: "L0382/ESP/8"
    };

    let currentTopic = null;

    Plotly.newPlot(gd, [], {
      title: "활동 감지 그래프",
      xaxis: { title: "Time", type: "date" },
      yaxis: { title: "Value" }
    }, { responsive: true });

    socket.on("cada_result", msg => {
      const t = msg.topic;
      const x = new Date(msg.timestamp_ms);

      if (currentTopic && t === currentTopic) {
        if (!(t in trMap)) {
          trMap[t] = { traces: {} };

          let zoneNumber = null;
          for (const [key, value] of Object.entries(zoneTopics)) {
            if (value === t) {
              zoneNumber = key;
              break;
            }
          }

          Plotly.relayout(gd, { 
            title: `Zone ${zoneNumber} - ${t} Raw CSI 데이터`,
            yaxis: { title: "Amplitude" }
          });
          
          if (msg.raw_amplitude) {
            const traces = [];
            const colors = [
              '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', 
              '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf',
              '#aec7e8', '#ffbb78', '#98df8a', '#ff9896', '#c5b0d5',
              '#c49c94', '#f7b6d2', '#c7c7c7', '#dbdb8d', '#9edae5'
            ];

            for (let i = 0; i < msg.raw_amplitude.length; i++) {
              const colorIdx = i % colors.length;
              const trace = { 
                x: [x], 
                y: [msg.raw_amplitude[i]], 
                mode: 'lines', 
                showlegend: false,
                line: { color: colors[colorIdx], width: 1 }
              };
              traces.push(trace);
              trMap[t].traces[i] = gd.data.length + i;
            }

            Plotly.addTraces(gd, traces);
          }
        } else {
          if (msg.raw_amplitude && trMap[t].traces) {
            for (let i = 0; i < msg.raw_amplitude.length; i++) {
              if (trMap[t].traces[i] !== undefined) {
                Plotly.extendTraces(gd, 
                  { x: [[x]], y: [[msg.raw_amplitude[i]]] }, 
                  [trMap[t].traces[i]], 
                  MAXPTS
                );
              }
            }
          }
        }
      }
    });

    socket.on("zone_status", function (zoneData) {
      console.log("Zone status received:", zoneData);
      updateZoneStatus(zoneData);
    });

    socket.on("mode_status", function (modeData) {
      console.log("Mode status received:", modeData);
      if (modeData && modeData.mode) {
        updateStatus(modeData.mode);
      }
    });

    function requestReset() {
      fetch("/reset", { method: "POST" });
    }

    function requestRedetection() {
      fetch("/redetection", { method: "POST" });
    }

    const overlay = document.getElementById("alert-overlay");
    function flashOverlay() {
      overlay.classList.add("active");
      setTimeout(() => overlay.classList.remove("active"), 500);
    }

    function activateZone(zoneNumber) {
      for (let i = 1; i <= 6; i++) {
        document.getElementById(`zone-${i}`).classList.remove('active');
      }
      if (zoneNumber >= 1 && zoneNumber <= 6) {
        document.getElementById(`zone-${zoneNumber}`).classList.add('active');
      }
    }

    const zoneCooldowns = {};
    const zoneActiveFlags = {};

    function updateZoneStatus(zoneData) {
      const now = Date.now();

      for (const [zoneKey, state] of Object.entries(zoneData)) {
        if (state === "alert") {
          const zoneNumber = parseInt(zoneKey.split('_')[1]);
          if (zoneNumber >= 1 && zoneNumber <= 6) {
            const lastActivation = zoneCooldowns[zoneNumber] || 0;
            const isCurrentlyActive = zoneActiveFlags[zoneNumber] || false;

            if ((now - lastActivation) > 3000 && !isCurrentlyActive) {
              const zoneElement = document.getElementById(`zone-${zoneNumber}`);
              zoneElement.classList.add('active');
              zoneActiveFlags[zoneNumber] = true;

              setTimeout(() => {
                zoneElement.classList.remove('active');
                zoneActiveFlags[zoneNumber] = false;
              }, 1500);

              zoneCooldowns[zoneNumber] = now;
            }
          }
        }
      }
    }

    let currentZoneNumber = null;
    
    function showZoneGraph(zoneNumber) {
      if (currentZoneNumber !== null && zoneTopics[currentZoneNumber]) {
        socket.emit('unsubscribe_topic', { topic: zoneTopics[currentZoneNumber] });
      }

      currentZoneNumber = zoneNumber;

      const zoneTopic = zoneTopics[zoneNumber];
      currentTopic = zoneTopic;

      const layout = {
        title: `Zone ${zoneNumber} CSI 데이터`,
        xaxis: { title: "Time", type: "date" },
        yaxis: { title: "Amplitude" }
      };

      Plotly.newPlot(gd, [], layout, { responsive: true });

      socket.emit('subscribe_topic', { topic: zoneTopic, zoneNumber: zoneNumber });

      trMap = {};

      for (let i = 1; i <= 6; i++) {
        document.getElementById(`zone-${i}`).classList.remove('selected');
      }

      document.getElementById(`zone-${zoneNumber}`).classList.add('selected');
    }
    

  </script>
</body>

</html>